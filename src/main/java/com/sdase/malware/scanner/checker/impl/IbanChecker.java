package com.sdase.malware.scanner.checker.impl;

import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import com.sdase.malware.scanner.checker.Checker;
import com.sdase.malware.scanner.streaming.model.CheckResultEvent;
import com.sdase.malware.scanner.streaming.model.CheckResultEvent.StateEnum;

@Component
public class IbanChecker implements Checker {

	private static final Pattern PATTERN = Pattern.compile("([A-Z]{2}[ \\-]?[0-9]{2})(?=(?:[ \\-]?[A-Z0-9]){9,30})((?:[ \\-]?[A-Z0-9]{3,5}){2,7})([ \\-]?[A-Z0-9]{1,3})");
	
	private static final String NAME = "iban-checker";
	
	@Value("${business.iban-blacklist}")
	private List<String> ibanBlacklist;
	
	@Override
	public CheckResultEvent check(String content) {
		Matcher matcher = PATTERN.matcher(content);
		if(!matcher.find()){
			return new CheckResultEvent(StateEnum.IGNORED, NAME, "This file does not have an IBAN number");
		}
		if (ibanBlacklist.stream().anyMatch(
				iban -> iban.replaceAll("\\s", "").equalsIgnoreCase(matcher.group().replaceAll("\\s", "")))) {
			return new CheckResultEvent(StateEnum.SUSPICIOUS, NAME, "This IBAN code is on blacklist");
		}
		return new CheckResultEvent(StateEnum.OK, NAME, "This file has a valid IBAN code");
	}

}
